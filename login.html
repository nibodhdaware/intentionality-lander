<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Login - Intentionality</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        />
        <link rel="icon" type="image/png" sizes="16x16" href="icon16.png" />
        <style>
            body {
                background: #18344a;
            }
            .google-btn {
                background: #fff;
                color: #444;
                border: 1px solid #e0e0e0;
                font-weight: 600;
                transition: box-shadow 0.2s, border-color 0.2s;
            }
            .google-btn:hover {
                box-shadow: 0 2px 8px rgba(66, 133, 244, 0.15);
                border-color: #4285f4;
                color: #4285f4;
            }
            .google-icon {
                color: #4285f4;
            }
            .debug-console {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 12px;
                margin-top: 20px;
                max-height: 200px;
                overflow-y: auto;
                font-family: "Courier New", monospace;
                font-size: 12px;
                white-space: pre-wrap;
            }
        </style>
    </head>
    <body class="min-h-screen flex items-center justify-center">
        <div
            class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg flex flex-col items-center"
        >
            <h1 class="text-2xl font-bold text-deepblue mb-2">
                Sign in to Intentionality
            </h1>
            <p class="text-gray-600 mb-6 text-center text-base">
                Sign in with Google to sync your activity and unlock all
                features.
            </p>
            <button
                id="loginWithGoogleButton"
                class="google-btn w-full flex items-center justify-center gap-3 py-2.5 px-4 rounded-lg text-base mb-4"
            >
                <i class="fab fa-google google-icon text-lg"></i>
                <span>Sign in with Google</span>
            </button>
            <a
                href="index.html"
                class="google-btn w-full flex items-center justify-center gap-3 py-2.5 px-4 rounded-lg text-base mb-4"
            >
                <i class="fas fa-arrow-left"></i>
                Back to Home
            </a>
            <div
                id="loginStatus"
                class="text-medblue mt-5 text-center text-sm"
            ></div>

            <!-- Debug console -->
            <div class="w-full">
                <h3 class="text-sm font-semibold text-gray-700 mb-2">
                    Debug Console:
                </h3>
                <div id="debugConsole" class="debug-console"></div>
                <button
                    id="clearDebug"
                    class="mt-2 px-3 py-1 bg-gray-500 text-white text-xs rounded hover:bg-gray-600"
                >
                    Clear Debug
                </button>
            </div>
        </div>

        <script>
            // Function to communicate with Chrome extension
            function sendToExtension(userInfo) {
                debugLog(
                    "üì° Attempting to communicate with Chrome extension...",
                );

                // Check if we're in a Chrome extension context
                if (
                    typeof chrome !== "undefined" &&
                    chrome.runtime &&
                    chrome.runtime.sendMessage
                ) {
                    // Method 1: Send to specific extension ID (replace with your extension ID)
                    const YOUR_EXTENSION_ID = "YOUR_EXTENSION_ID_HERE"; // Replace this!

                    // Try sending to specific extension ID
                    chrome.runtime.sendMessage(
                        YOUR_EXTENSION_ID,
                        {
                            type: "USER_LOGGED_IN",
                            userInfo: userInfo,
                            timestamp: Date.now(),
                        },
                        function (response) {
                            if (chrome.runtime.lastError) {
                                debugLog(
                                    "‚ö†Ô∏è Extension communication error (specific ID):",
                                    chrome.runtime.lastError.message,
                                );

                                // Method 2: Try sending to any listening extension
                                try {
                                    chrome.runtime.sendMessage(
                                        {
                                            type: "USER_LOGGED_IN",
                                            userInfo: userInfo,
                                            timestamp: Date.now(),
                                        },
                                        function (response) {
                                            if (chrome.runtime.lastError) {
                                                debugLog(
                                                    "‚ö†Ô∏è Extension communication error (broadcast):",
                                                    chrome.runtime.lastError
                                                        .message,
                                                );
                                            } else {
                                                debugLog(
                                                    "‚úÖ Successfully sent user info to extension",
                                                    response,
                                                );
                                            }
                                        },
                                    );
                                } catch (broadcastError) {
                                    debugLog(
                                        "‚ùå Broadcast communication failed:",
                                        broadcastError,
                                    );
                                }
                            } else {
                                debugLog(
                                    "‚úÖ Successfully sent user info to extension (specific ID)",
                                    response,
                                );
                            }
                        },
                    );

                    // Method 3: PostMessage to window (for content scripts)
                    try {
                        window.postMessage(
                            {
                                type: "INTENTIONALITY_USER_LOGGED_IN",
                                userInfo: userInfo,
                                source: "intentionality-login",
                            },
                            "*",
                        );
                        debugLog(
                            "üì§ Posted message to window for content script pickup",
                        );
                    } catch (postMessageError) {
                        debugLog("‚ö†Ô∏è PostMessage failed:", postMessageError);
                    }
                } else {
                    debugLog(
                        "‚ö†Ô∏è Chrome runtime not available - not in extension context",
                    );

                    // Alternative: Use localStorage for extension to pick up
                    try {
                        localStorage.setItem(
                            "intentionality_user_login",
                            JSON.stringify({
                                userInfo: userInfo,
                                timestamp: Date.now(),
                            }),
                        );
                        debugLog(
                            "üíæ Stored login info in localStorage for extension pickup",
                        );

                        // Dispatch custom event
                        window.dispatchEvent(
                            new CustomEvent("intentionalityUserLoggedIn", {
                                detail: userInfo,
                            }),
                        );
                        debugLog("üì° Dispatched custom event for extension");
                    } catch (localStorageError) {
                        debugLog(
                            "‚ùå localStorage backup failed:",
                            localStorageError,
                        );
                    }
                }
            }

            // Function to get extension ID dynamically
            function getExtensionId() {
                debugLog("üîç Attempting to detect extension ID...");

                // Check if extension injected its ID
                if (window.INTENTIONALITY_EXTENSION_ID) {
                    debugLog(
                        "‚úÖ Found extension ID from window:",
                        window.INTENTIONALITY_EXTENSION_ID,
                    );
                    return window.INTENTIONALITY_EXTENSION_ID;
                }

                // Check localStorage for extension ID
                const storedExtensionId = localStorage.getItem(
                    "intentionality_extension_id",
                );
                if (storedExtensionId) {
                    debugLog(
                        "‚úÖ Found extension ID from localStorage:",
                        storedExtensionId,
                    );
                    return storedExtensionId;
                }

                debugLog("‚ö†Ô∏è Extension ID not found - using placeholder");
                return "YOUR_EXTENSION_ID_HERE";
            }
            function debugLog(message, data = null) {
                const timestamp = new Date().toLocaleTimeString();
                const debugConsole = document.getElementById("debugConsole");
                let logMessage = `[${timestamp}] ${message}`;

                if (data) {
                    logMessage += "\n" + JSON.stringify(data, null, 2);
                }

                debugConsole.textContent += logMessage + "\n\n";
                debugConsole.scrollTop = debugConsole.scrollHeight;

                // Also log to browser console
                console.log(message, data);
            }

            // Clear debug function
            document.getElementById("clearDebug").onclick = function () {
                document.getElementById("debugConsole").textContent = "";
            };

            debugLog("üöÄ Page loaded, initializing Firebase...");

            const firebaseConfig = {
                apiKey: "AIzaSyCepAVjbZsx0z-M0sTvgp48AAt4bYBSq-U",
                authDomain: "intentionality-1ce65.firebaseapp.com",
                projectId: "intentionality-1ce65",
                storageBucket: "intentionality-1ce65.firebasestorage.app",
                messagingSenderId: "938266027514",
                appId: "1:938266027514:web:747ac62f30207ef05d3043",
                measurementId: "G-1891HVELCR",
            };

            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    debugLog("‚úÖ Firebase initialized successfully");
                } else {
                    debugLog("‚ÑπÔ∏è Firebase already initialized");
                }
            } catch (error) {
                debugLog("‚ùå Firebase initialization error", error);
            }

            // Check current auth state
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    debugLog("üë§ User is signed in", {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        emailVerified: user.emailVerified,
                        isAnonymous: user.isAnonymous,
                        metadata: {
                            creationTime: user.metadata.creationTime,
                            lastSignInTime: user.metadata.lastSignInTime,
                        },
                        providerData: user.providerData,
                    });

                    document.getElementById(
                        "loginStatus",
                    ).textContent = `‚úÖ Signed in as ${
                        user.displayName || user.email
                    }`;
                } else {
                    debugLog("üë§ No user signed in");
                    document.getElementById("loginStatus").textContent =
                        "Not signed in";
                }
            });

            // Login button click handler
            document.getElementById("loginWithGoogleButton").onclick =
                function () {
                    debugLog(
                        "üîÑ Login button clicked, starting Google sign-in...",
                    );

                    try {
                        const provider = new firebase.auth.GoogleAuthProvider();

                        // Add additional scopes if needed
                        provider.addScope("profile");
                        provider.addScope("email");

                        debugLog("üîÑ Trying popup sign-in first...");

                        // Try popup first (better for localhost)
                        firebase
                            .auth()
                            .signInWithPopup(provider)
                            .then((result) => {
                                debugLog("‚úÖ Popup sign-in successful!", {
                                    uid: result.user.uid,
                                    email: result.user.email,
                                    displayName: result.user.displayName,
                                    photoURL: result.user.photoURL,
                                    accessToken: result.credential
                                        ? result.credential.accessToken
                                        : null,
                                    idToken: result.credential
                                        ? result.credential.idToken
                                        : null,
                                });

                                document.getElementById(
                                    "loginStatus",
                                ).textContent = `‚úÖ Login successful! Welcome ${
                                    result.user.displayName || result.user.email
                                }`;

                                // Store user info in sessionStorage for debugging
                                try {
                                    const userInfo = {
                                        uid: result.user.uid,
                                        email: result.user.email,
                                        displayName: result.user.displayName,
                                        photoURL: result.user.photoURL,
                                        loginTime: new Date().toISOString(),
                                        accessToken: result.credential
                                            ? result.credential.accessToken
                                            : null,
                                        idToken: result.credential
                                            ? result.credential.idToken
                                            : null,
                                    };
                                    sessionStorage.setItem(
                                        "userInfo",
                                        JSON.stringify(userInfo),
                                    );
                                    debugLog(
                                        "üíæ User info stored in sessionStorage",
                                        userInfo,
                                    );

                                    // Communicate with Chrome extension
                                    sendToExtension(userInfo);
                                } catch (storageError) {
                                    debugLog(
                                        "‚ö†Ô∏è Could not store user info in sessionStorage",
                                        storageError,
                                    );
                                }
                            })
                            .catch((error) => {
                                debugLog(
                                    "‚ùå Popup sign-in failed, trying redirect...",
                                    {
                                        code: error.code,
                                        message: error.message,
                                    },
                                );

                                // If popup fails, fall back to redirect
                                if (
                                    error.code === "auth/popup-blocked" ||
                                    error.code === "auth/popup-closed-by-user"
                                ) {
                                    debugLog(
                                        "üîÑ Falling back to redirect method...",
                                    );
                                    firebase
                                        .auth()
                                        .signInWithRedirect(provider);
                                } else {
                                    document.getElementById(
                                        "loginStatus",
                                    ).textContent =
                                        "Login failed: " + error.message;
                                }
                            });
                    } catch (error) {
                        debugLog("‚ùå Error during sign-in initiation", error);
                        document.getElementById("loginStatus").textContent =
                            "Error: " + error.message;
                    }
                };

            // Handle redirect result
            debugLog("üîÑ Checking for redirect result...");

            firebase
                .auth()
                .getRedirectResult()
                .then((result) => {
                    debugLog("üì• Redirect result received", {
                        hasUser: !!result.user,
                        hasCredential: !!result.credential,
                        operationType: result.operationType,
                    });

                    if (result.user) {
                        debugLog("‚úÖ Sign-in successful!", {
                            uid: result.user.uid,
                            email: result.user.email,
                            displayName: result.user.displayName,
                            photoURL: result.user.photoURL,
                            accessToken: result.credential
                                ? result.credential.accessToken
                                : null,
                            idToken: result.credential
                                ? result.credential.idToken
                                : null,
                        });

                        document.getElementById(
                            "loginStatus",
                        ).textContent = `‚úÖ Login successful! Welcome ${
                            result.user.displayName || result.user.email
                        }`;

                        // Store user info in sessionStorage for debugging
                        try {
                            const userInfo = {
                                uid: result.user.uid,
                                email: result.user.email,
                                displayName: result.user.displayName,
                                photoURL: result.user.photoURL,
                                loginTime: new Date().toISOString(),
                            };
                            sessionStorage.setItem(
                                "userInfo",
                                JSON.stringify(userInfo),
                            );
                            debugLog(
                                "üíæ User info stored in sessionStorage",
                                userInfo,
                            );
                        } catch (storageError) {
                            debugLog(
                                "‚ö†Ô∏è Could not store user info in sessionStorage",
                                storageError,
                            );
                        }
                    } else if (result.operationType) {
                        debugLog(
                            "‚ÑπÔ∏è Redirect occurred but no user found",
                            result,
                        );
                    } else {
                        debugLog("‚ÑπÔ∏è No redirect result (normal page load)");
                    }
                })
                .catch((error) => {
                    debugLog("‚ùå Redirect result error", {
                        code: error.code,
                        message: error.message,
                        email: error.email,
                        credential: error.credential,
                    });

                    document.getElementById("loginStatus").textContent =
                        "Login failed: " + error.message;
                });

            // Additional debugging - check if we're in popup/redirect mode
            debugLog("üîç Environment check", {
                userAgent: navigator.userAgent,
                isPopupSupported: firebase.auth().isSignInWithEmailLink
                    ? "Supported"
                    : "Not supported",
                currentURL: window.location.href,
                referrer: document.referrer,
                sessionStorage: sessionStorage.getItem("userInfo")
                    ? "Has stored user info"
                    : "No stored user info",
                protocol: window.location.protocol,
                hostname: window.location.hostname,
                port: window.location.port,
            });

            // Test Firebase connection
            debugLog("üîó Testing Firebase connection...");
            firebase.auth().currentUser; // This should not throw an error if Firebase is properly connected

            // Check for any stored user info from previous sessions
            const storedUserInfo = sessionStorage.getItem("userInfo");
            if (storedUserInfo) {
                try {
                    const userInfo = JSON.parse(storedUserInfo);
                    debugLog(
                        "üìÇ Found stored user info from previous session",
                        userInfo,
                    );
                } catch (e) {
                    debugLog("‚ö†Ô∏è Error parsing stored user info", e);
                }
            }
        </script>
    </body>
</html>
