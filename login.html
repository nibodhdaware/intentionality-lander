<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Login - Intentionality</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        />
        <link rel="icon" type="image/png" sizes="16x16" href="icon16.png" />
        <style>
            body {
                background: #18344a;
            }
            .google-btn {
                background: #fff;
                color: #444;
                border: 1px solid #e0e0e0;
                font-weight: 600;
                transition: box-shadow 0.2s, border-color 0.2s;
            }
            .google-btn:hover {
                box-shadow: 0 2px 8px rgba(66, 133, 244, 0.15);
                border-color: #4285f4;
                color: #4285f4;
            }
            .google-icon {
                color: #4285f4;
            }
        </style>
    </head>
    <body class="min-h-screen flex items-center justify-center">
        <div
            class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg flex flex-col items-center"
        >
            <h1 class="text-2xl font-bold text-deepblue mb-2">
                Sign in to Intentionality
            </h1>
            <p class="text-gray-600 mb-6 text-center text-base">
                Sign in with Google to sync your activity and unlock all
                features.
            </p>
            <button
                id="loginWithGoogleButton"
                class="google-btn w-full flex items-center justify-center gap-3 py-2.5 px-4 rounded-lg text-base mb-4"
            >
                <i class="fab fa-google google-icon text-lg"></i>
                <span>Sign in with Google</span>
            </button>
            <a
                href="index.html"
                class="google-btn w-full flex items-center justify-center gap-3 py-2.5 px-4 rounded-lg text-base mb-4"
            >
                <i class="fas fa-arrow-left"></i>
                Back to Home
            </a>
            <div
                id="loginStatus"
                class="text-medblue mt-5 text-center text-sm"
            ></div>
        </div>

        <script>
            // Function to communicate with Chrome extension
            function sendToExtension(userInfo) {
                // Check if we're in a Chrome extension context
                if (
                    typeof chrome !== "undefined" &&
                    chrome.runtime &&
                    chrome.runtime.sendMessage
                ) {
                    // Method 1: Send to specific extension ID (replace with your extension ID)
                    const YOUR_EXTENSION_ID = "YOUR_EXTENSION_ID_HERE"; // Replace this!

                    // Try sending to specific extension ID
                    chrome.runtime.sendMessage(
                        YOUR_EXTENSION_ID,
                        {
                            type: "USER_LOGGED_IN",
                            userInfo: userInfo,
                            timestamp: Date.now(),
                        },
                        function (response) {
                            if (chrome.runtime.lastError) {
                                // Method 2: Try sending to any listening extension
                                try {
                                    chrome.runtime.sendMessage(
                                        {
                                            type: "USER_LOGGED_IN",
                                            userInfo: userInfo,
                                            timestamp: Date.now(),
                                        },
                                        function (response) {
                                            // Handle response if needed
                                        },
                                    );
                                } catch (broadcastError) {
                                    // Handle broadcast error
                                }
                            }
                        },
                    );

                    // Method 3: PostMessage to window (for content scripts)
                    try {
                        window.postMessage(
                            {
                                type: "INTENTIONALITY_USER_LOGGED_IN",
                                userInfo: userInfo,
                                source: "intentionality-login",
                            },
                            "*",
                        );
                    } catch (postMessageError) {
                        // Handle postMessage error
                    }
                } else {
                    // Alternative: Use localStorage for extension to pick up
                    try {
                        localStorage.setItem(
                            "intentionality_user_login",
                            JSON.stringify({
                                userInfo: userInfo,
                                timestamp: Date.now(),
                            }),
                        );

                        // Dispatch custom event
                        window.dispatchEvent(
                            new CustomEvent("intentionalityUserLoggedIn", {
                                detail: userInfo,
                            }),
                        );
                    } catch (localStorageError) {
                        // Handle localStorage error
                    }
                }
            }

            // Function to get extension ID dynamically
            function getExtensionId() {
                // Check if extension injected its ID
                if (window.INTENTIONALITY_EXTENSION_ID) {
                    return window.INTENTIONALITY_EXTENSION_ID;
                }

                // Check localStorage for extension ID
                const storedExtensionId = localStorage.getItem(
                    "intentionality_extension_id",
                );
                if (storedExtensionId) {
                    return storedExtensionId;
                }

                return "YOUR_EXTENSION_ID_HERE";
            }

            const firebaseConfig = {
                apiKey: "AIzaSyCepAVjbZsx0z-M0sTvgp48AAt4bYBSq-U",
                authDomain: "intentionality-1ce65.firebaseapp.com",
                projectId: "intentionality-1ce65",
                storageBucket: "intentionality-1ce65.firebasestorage.app",
                messagingSenderId: "938266027514",
                appId: "1:938266027514:web:747ac62f30207ef05d3043",
                measurementId: "G-1891HVELCR",
            };

            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
            } catch (error) {
                // Handle Firebase initialization error
            }

            // Check current auth state
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    document.getElementById(
                        "loginStatus",
                    ).textContent = `✅ Signed in as ${
                        user.displayName || user.email
                    }`;
                } else {
                    document.getElementById("loginStatus").textContent =
                        "Not signed in";
                }
            });

            // Login button click handler
            document.getElementById("loginWithGoogleButton").onclick =
                function () {
                    try {
                        const provider = new firebase.auth.GoogleAuthProvider();

                        // Add additional scopes if needed
                        provider.addScope("profile");
                        provider.addScope("email");

                        // Try popup first (better for localhost)
                        firebase
                            .auth()
                            .signInWithPopup(provider)
                            .then((result) => {
                                document.getElementById(
                                    "loginStatus",
                                ).textContent = `✅ Login successful! Welcome ${
                                    result.user.displayName || result.user.email
                                }`;

                                // Store user info in sessionStorage
                                try {
                                    const userInfo = {
                                        uid: result.user.uid,
                                        email: result.user.email,
                                        displayName: result.user.displayName,
                                        photoURL: result.user.photoURL,
                                        loginTime: new Date().toISOString(),
                                        accessToken: result.credential
                                            ? result.credential.accessToken
                                            : null,
                                        idToken: result.credential
                                            ? result.credential.idToken
                                            : null,
                                    };
                                    sessionStorage.setItem(
                                        "userInfo",
                                        JSON.stringify(userInfo),
                                    );

                                    // Communicate with Chrome extension
                                    sendToExtension(userInfo);
                                } catch (storageError) {
                                    // Handle storage error
                                }
                            })
                            .catch((error) => {
                                // If popup fails, fall back to redirect
                                if (
                                    error.code === "auth/popup-blocked" ||
                                    error.code === "auth/popup-closed-by-user"
                                ) {
                                    firebase
                                        .auth()
                                        .signInWithRedirect(provider);
                                } else {
                                    document.getElementById(
                                        "loginStatus",
                                    ).textContent =
                                        "Login failed: " + error.message;
                                }
                            });
                    } catch (error) {
                        document.getElementById("loginStatus").textContent =
                            "Error: " + error.message;
                    }
                };

            // Handle redirect result
            firebase
                .auth()
                .getRedirectResult()
                .then((result) => {
                    if (result.user) {
                        document.getElementById(
                            "loginStatus",
                        ).textContent = `✅ Login successful! Welcome ${
                            result.user.displayName || result.user.email
                        }`;

                        // Store user info in sessionStorage
                        try {
                            const userInfo = {
                                uid: result.user.uid,
                                email: result.user.email,
                                displayName: result.user.displayName,
                                photoURL: result.user.photoURL,
                                loginTime: new Date().toISOString(),
                            };
                            sessionStorage.setItem(
                                "userInfo",
                                JSON.stringify(userInfo),
                            );
                        } catch (storageError) {
                            // Handle storage error
                        }
                    }
                })
                .catch((error) => {
                    document.getElementById("loginStatus").textContent =
                        "Login failed: " + error.message;
                });
        </script>
    </body>
</html>
