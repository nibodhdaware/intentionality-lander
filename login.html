<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Login - Intentionality</title>
        <link href="dist/output.css" rel="stylesheet" />
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        />
        <link rel="icon" type="image/png" sizes="16x16" href="icon16.png" />

        <style>
            body {
                background: #18344a;
            }
            .google-btn {
                background: #fff;
                color: #444;
                border: 1px solid #e0e0e0;
                font-weight: 600;
                transition: box-shadow 0.2s, border-color 0.2s;
            }
            .google-btn:hover {
                box-shadow: 0 2px 8px rgba(66, 133, 244, 0.15);
                border-color: #4285f4;
                color: #4285f4;
            }
            .google-btn.dark {
                background: #1e293b;
                color: #e2e8f0;
                border: 1px solid #334155;
            }
            .google-btn.dark:hover {
                box-shadow: 0 2px 8px rgba(66, 133, 244, 0.15);
                border-color: #4285f4;
                color: #4285f4;
            }
            .google-icon {
                color: #4285f4;
            }
            /* Dark mode transitions */
            * {
                transition: background-color 0.3s ease, color 0.3s ease,
                    border-color 0.3s ease;
            }
        </style>
    </head>
    <body class="min-h-screen flex items-center justify-center">
        <div
            class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg flex flex-col items-center dark:bg-darkbg dark:text-darktext"
        >
            <h1
                class="text-2xl font-bold text-deepblue mb-2 dark:text-darktext"
            >
                Sign in to Intentionality
            </h1>
            <p
                class="text-gray-600 mb-6 text-center text-base dark:text-gray-300"
            >
                Sign in to sync your activity and unlock all features.
            </p>

            <!-- Email/Password Login Form -->
            <div id="emailLoginForm" class="w-full mb-4">
                <input
                    type="email"
                    id="emailInput"
                    placeholder="Email address"
                    class="w-full px-4 py-2.5 rounded-lg border border-gray-300 mb-3 text-base focus:outline-none focus:border-medblue dark:bg-slate-700 dark:border-slate-600 dark:text-darktext"
                />
                <input
                    type="password"
                    id="passwordInput"
                    placeholder="Password"
                    class="w-full px-4 py-2.5 rounded-lg border border-gray-300 mb-3 text-base focus:outline-none focus:border-medblue dark:bg-slate-700 dark:border-slate-600 dark:text-darktext"
                />
                <button
                    id="loginWithEmailButton"
                    class="w-full bg-medblue text-white py-2.5 px-4 rounded-lg text-base font-semibold hover:bg-deepblue transition-colors mb-2"
                >
                    Sign In
                </button>
                <button
                    id="signupWithEmailButton"
                    class="w-full bg-lightblue text-white py-2.5 px-4 rounded-lg text-base font-semibold hover:bg-medblue transition-colors mb-2"
                >
                    Create Account
                </button>
                <button
                    id="resetPasswordButton"
                    class="w-full text-medblue text-sm hover:underline dark:text-lightblue mb-3"
                >
                    Forgot password?
                </button>
            </div>

            <!-- Divider -->
            <div class="w-full flex items-center gap-3 mb-4">
                <div class="flex-1 h-px bg-gray-300 dark:bg-slate-600"></div>
                <span class="text-gray-500 text-sm dark:text-gray-400">or</span>
                <div class="flex-1 h-px bg-gray-300 dark:bg-slate-600"></div>
            </div>

            <button
                id="loginWithGoogleButton"
                class="google-btn w-full flex items-center justify-center gap-3 py-2.5 px-4 rounded-lg text-base mb-4 dark:google-btn-dark"
            >
                <i class="fab fa-google google-icon text-lg"></i>
                <span>Sign in with Google</span>
            </button>
            <a
                href="index.html"
                class="google-btn w-full flex items-center justify-center gap-3 py-2.5 px-4 rounded-lg text-base mb-4 dark:google-btn-dark"
            >
                <i class="fas fa-arrow-left"></i>
                Back to Home
            </a>
            <div
                id="loginStatus"
                class="text-medblue mt-5 text-center text-sm dark:text-lightblue"
            ></div>
        </div>

        <script>
            // Firebase initialization
            const firebaseConfig = {
                apiKey: "AIzaSyCepAVjbZsx0z-M0sTvgp48AAt4bYBSq-U",
                authDomain: "intentionality-1ce65.firebaseapp.com",
                projectId: "intentionality-1ce65",
                storageBucket: "intentionality-1ce65.firebasestorage.app",
                messagingSenderId: "938266027514",
                appId: "1:938266027514:web:747ac62f30207ef05d3043",
                measurementId: "G-1891HVELCR",
            };

            // Initialize Firebase
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                console.log("Firebase initialized successfully");
            } catch (error) {
                console.error("Firebase initialization error:", error);
            }

            // Setup auth state listener
            firebase.auth().onAuthStateChanged((user) => {
                const loginStatus = document.getElementById("loginStatus");

                if (user) {
                    console.log("Firebase Auth: User signed in", {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                    });

                    if (loginStatus) {
                        loginStatus.textContent = `✅ Signed in as ${
                            user.displayName || user.email
                        }`;
                    }

                    // Get fresh token and send to extension
                    user.getIdToken(true).then((token) => {
                        console.log("Got fresh ID token, sending to extension");
                        sendLoginSuccessToExtension(user, token);
                    });
                } else {
                    console.log("Firebase Auth: User signed out");
                    if (loginStatus) {
                        loginStatus.textContent = "";
                    }
                }
            });

            async function sendLoginSuccessToExtension(user, token) {
                console.log("Attempting to send login message to extension");
                const startTime = Date.now();

                const message = {
                    type: "INTENTIONALITY_USER_LOGGED_IN",
                    token: user.stsTokenManager?.accessToken || token,
                    userInfo: {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        loginTime: new Date().toISOString(),
                    },
                    timestamp: startTime,
                };

                const promises = [];

                // 1. Store in localStorage and chrome.storage
                promises.push(
                    new Promise((resolve) => {
                        try {
                            // Store in localStorage as backup
                            localStorage.setItem(
                                "intentionality_user_login",
                                JSON.stringify(message.userInfo)
                            );
                            localStorage.setItem(
                                "intentionality_auth_token",
                                message.token
                            );
                            console.log("Saved to localStorage");
                            resolve(true);
                        } catch (error) {
                            console.warn("localStorage failed:", error);
                            resolve(false);
                        }
                    })
                );

                // 2. Send to content script via postMessage (try multiple origins)
                promises.push(
                    new Promise((resolve) => {
                        try {
                            // Send message to be picked up by content script
                            [
                                window.location.origin,
                                'https://intentionality.app',
                                'https://intentionality-1ce65.firebaseapp.com',
                                'http://localhost:5500',
                                'http://localhost:3000',
                                'http://127.0.0.1:5500'
                            ].forEach(origin => {
                                window.postMessage(message, origin);
                                console.log('Sent message to:', origin);
                            });

                            console.log(
                                "Posted messages to potential extension targets",
                            );
                            resolve(true);
                        } catch (error) {
                            console.warn("postMessage failed:", error);
                            resolve(false);
                        }
                    }),
                );

                // Wait for all communication attempts
                try {
                    const results = await Promise.allSettled(promises);
                    console.log("Communication attempts completed:", results);

                    // Store timestamp to prevent duplicate processing
                    localStorage.setItem(
                        "last_login_timestamp",
                        startTime.toString(),
                    );

                    // Notify any local listeners
                    window.dispatchEvent(
                        new CustomEvent("intentionalityUserLoggedIn", {
                            detail: message,
                        }),
                    );
                } catch (error) {
                    console.error("Error in communication:", error);
                }

                const firebaseConfig = {
                    apiKey: "AIzaSyCepAVjbZsx0z-M0sTvgp48AAt4bYBSq-U",
                    authDomain: "intentionality-1ce65.firebaseapp.com",
                    projectId: "intentionality-1ce65",
                    storageBucket: "intentionality-1ce65.firebasestorage.app",
                    messagingSenderId: "938266027514",
                    appId: "1:938266027514:web:747ac62f30207ef05d3043",
                    measurementId: "G-1891HVELCR",
                };

                try {
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                } catch (error) {
                    console.error("Firebase initialization error:", error);
                }

                // Check current auth state
                firebase.auth().onAuthStateChanged((user) => {
                    const loginStatus = document.getElementById("loginStatus");

                    if (user) {
                        console.log("Firebase Auth: User signed in", {
                            uid: user.uid,
                            email: user.email,
                            displayName: user.displayName,
                        });

                        if (loginStatus) {
                            loginStatus.textContent = `✅ Signed in as ${
                                user.displayName || user.email
                            }`;
                        }

                        // Get the user's ID token and send to extension only if not already sent
                        const lastLoginTimestamp = localStorage.getItem(
                            "last_login_timestamp",
                        );
                        const currentTime = Date.now();
                        if (
                            !lastLoginTimestamp ||
                            currentTime - parseInt(lastLoginTimestamp) > 5000
                        ) {
                            user.getIdToken(true)
                                .then((token) => {
                                    console.log(
                                        "Got fresh ID token, sending to extension",
                                    );
                                    localStorage.setItem(
                                        "last_login_timestamp",
                                        currentTime.toString(),
                                    );
                                    return sendLoginSuccessToExtension(
                                        user,
                                        token,
                                    );
                                })
                                .catch((error) => {
                                    console.error(
                                        "Error getting ID token:",
                                        error,
                                    );
                                    localStorage.setItem(
                                        "last_login_timestamp",
                                        currentTime.toString(),
                                    );
                                    return sendLoginSuccessToExtension(
                                        user,
                                        null,
                                    );
                                });
                        }
                    } else {
                        console.log("Firebase Auth: User signed out");
                        if (loginStatus) {
                            loginStatus.textContent = "Not signed in";
                        }
                    }
                });

                // Email/Password Login Handler
                document.getElementById("loginWithEmailButton").onclick =
                    function () {
                        const email = document
                            .getElementById("emailInput")
                            .value.trim();
                        const password =
                            document.getElementById("passwordInput").value;

                        if (!email || !password) {
                            document.getElementById("loginStatus").textContent =
                                "❌ Please enter both email and password";
                            return;
                        }

                        document.getElementById("loginStatus").textContent =
                            "Signing in...";

                        firebase
                            .auth()
                            .signInWithEmailAndPassword(email, password)
                            .then((result) => {
                                document.getElementById(
                                    "loginStatus",
                                ).textContent = `✅ Login successful! Welcome ${result.user.email}`;

                                // Get Firebase ID token and send to extension
                                result.user.getIdToken(true).then((token) => {
                                    sendLoginSuccessToExtension(
                                        result.user,
                                        token,
                                    );
                                });
                            })
                            .catch((error) => {
                                let errorMessage = "Login failed";
                                switch (error.code) {
                                    case "auth/invalid-email":
                                        errorMessage =
                                            "❌ Invalid email address";
                                        break;
                                    case "auth/user-disabled":
                                        errorMessage =
                                            "❌ This account has been disabled";
                                        break;
                                    case "auth/user-not-found":
                                        errorMessage =
                                            "❌ No account found with this email";
                                        break;
                                    case "auth/wrong-password":
                                        errorMessage = "❌ Incorrect password";
                                        break;
                                    case "auth/invalid-credential":
                                        errorMessage =
                                            "❌ Invalid email or password";
                                        break;
                                    default:
                                        errorMessage = "❌ " + error.message;
                                }
                                document.getElementById(
                                    "loginStatus",
                                ).textContent = errorMessage;
                            });
                    };

                // Email/Password Signup Handler
                document.getElementById("signupWithEmailButton").onclick =
                    function () {
                        const email = document
                            .getElementById("emailInput")
                            .value.trim();
                        const password =
                            document.getElementById("passwordInput").value;

                        if (!email || !password) {
                            document.getElementById("loginStatus").textContent =
                                "❌ Please enter both email and password";
                            return;
                        }

                        if (password.length < 6) {
                            document.getElementById("loginStatus").textContent =
                                "❌ Password must be at least 6 characters";
                            return;
                        }

                        document.getElementById("loginStatus").textContent =
                            "Creating account...";

                        firebase
                            .auth()
                            .createUserWithEmailAndPassword(email, password)
                            .then((result) => {
                                document.getElementById(
                                    "loginStatus",
                                ).textContent = `✅ Account created! Welcome ${result.user.email}`;

                                // Get Firebase ID token and send to extension
                                result.user.getIdToken(true).then((token) => {
                                    sendLoginSuccessToExtension(
                                        result.user,
                                        token,
                                    );
                                });
                            })
                            .catch((error) => {
                                let errorMessage = "Signup failed";
                                switch (error.code) {
                                    case "auth/email-already-in-use":
                                        errorMessage =
                                            "❌ An account with this email already exists";
                                        break;
                                    case "auth/invalid-email":
                                        errorMessage =
                                            "❌ Invalid email address";
                                        break;
                                    case "auth/operation-not-allowed":
                                        errorMessage =
                                            "❌ Email/password accounts are not enabled";
                                        break;
                                    case "auth/weak-password":
                                        errorMessage =
                                            "❌ Password is too weak";
                                        break;
                                    default:
                                        errorMessage = "❌ " + error.message;
                                }
                                document.getElementById(
                                    "loginStatus",
                                ).textContent = errorMessage;
                            });
                    };

                // Password Reset Handler
                document.getElementById("resetPasswordButton").onclick =
                    function () {
                        const email = document
                            .getElementById("emailInput")
                            .value.trim();

                        if (!email) {
                            document.getElementById("loginStatus").textContent =
                                "❌ Please enter your email address";
                            return;
                        }

                        document.getElementById("loginStatus").textContent =
                            "Sending password reset email...";

                        firebase
                            .auth()
                            .sendPasswordResetEmail(email)
                            .then(() => {
                                document.getElementById(
                                    "loginStatus",
                                ).textContent = `✅ Password reset email sent to ${email}`;
                            })
                            .catch((error) => {
                                let errorMessage = "Password reset failed";
                                switch (error.code) {
                                    case "auth/invalid-email":
                                        errorMessage =
                                            "❌ Invalid email address";
                                        break;
                                    case "auth/user-not-found":
                                        errorMessage =
                                            "❌ No account found with this email";
                                        break;
                                    default:
                                        errorMessage = "❌ " + error.message;
                                }
                                document.getElementById(
                                    "loginStatus",
                                ).textContent = errorMessage;
                            });
                    };

                // Login button click handler
                // Set up Google Sign In button
                const googleButton = document.getElementById(
                    "loginWithGoogleButton",
                );
                if (googleButton) {
                    console.log("Setting up Google Sign In button");
                    googleButton.onclick = async function (e) {
                        e.preventDefault();
                        try {
                            console.log("Google login button clicked");
                            const provider =
                                new firebase.auth.GoogleAuthProvider();
                            provider.addScope("profile");
                            provider.addScope("email");

                            console.log(
                                "Attempting Google sign in with popup...",
                            );
                            try {
                                const result = await firebase
                                    .auth()
                                    .signInWithPopup(provider);
                                console.log("Sign in successful:", result);

                                document.getElementById(
                                    "loginStatus",
                                ).textContent = `✅ Login successful! Welcome ${
                                    result.user.displayName || result.user.email
                                }`;

                                const token = await result.user.getIdToken(
                                    true,
                                );
                                console.log(
                                    "Got ID token, sending to extension",
                                );
                                await sendLoginSuccessToExtension(
                                    result.user,
                                    token,
                                );
                            } catch (signInError) {
                                console.error("Sign in error:", signInError);

                                if (
                                    signInError.code === "auth/popup-blocked" ||
                                    signInError.code ===
                                        "auth/popup-closed-by-user"
                                ) {
                                    console.log(
                                        "Popup blocked/closed, trying redirect...",
                                    );
                                    await firebase
                                        .auth()
                                        .signInWithRedirect(provider);
                                } else {
                                    document.getElementById(
                                        "loginStatus",
                                    ).textContent =
                                        "Login failed: " + signInError.message;
                                }
                            }
                        } catch (error) {
                            console.error("Login button error:", error);
                            document.getElementById("loginStatus").textContent =
                                "Login failed: " + error.message;
                            document.getElementById("loginStatus").textContent =
                                "Error: " + error.message;
                        }
                    };

                    // Handle redirect result
                    firebase
                        .auth()
                        .getRedirectResult()
                        .then((result) => {
                            if (result.user) {
                                document.getElementById(
                                    "loginStatus",
                                ).textContent = `✅ Login successful! Welcome ${
                                    result.user.displayName || result.user.email
                                }`;

                                result.user.getIdToken(true).then((token) => {
                                    sendLoginSuccessToExtension(
                                        result.user,
                                        token,
                                    );
                                });
                            }
                        })
                        .catch((error) => {
                            document.getElementById("loginStatus").textContent =
                                "Login failed: " + error.message;
                        });
                }
            }
        </script>
    </body>
</html>
