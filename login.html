<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Login - Intentionality</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        />
        <link rel="icon" type="image/png" sizes="16x16" href="icon16.png" />
        <script>
            tailwind.config = {
                darkMode: "media",
                theme: {
                    extend: {
                        colors: {
                            deepblue: "#18344A", // background
                            medblue: "#295B7A", // eye
                            lightblue: "#4A90A4", // eye ring
                            darkbg: "#0f1a2a", // dark mode background
                            darktext: "#e2e8f0", // dark mode text
                        },
                    },
                },
            };
        </script>
        <style>
            body {
                background: #18344a;
            }
            .google-btn {
                background: #fff;
                color: #444;
                border: 1px solid #e0e0e0;
                font-weight: 600;
                transition: box-shadow 0.2s, border-color 0.2s;
            }
            .google-btn:hover {
                box-shadow: 0 2px 8px rgba(66, 133, 244, 0.15);
                border-color: #4285f4;
                color: #4285f4;
            }
            .google-btn.dark {
                background: #1e293b;
                color: #e2e8f0;
                border: 1px solid #334155;
            }
            .google-btn.dark:hover {
                box-shadow: 0 2px 8px rgba(66, 133, 244, 0.15);
                border-color: #4285f4;
                color: #4285f4;
            }
            .google-icon {
                color: #4285f4;
            }
            /* Dark mode transitions */
            * {
                transition: background-color 0.3s ease, color 0.3s ease,
                    border-color 0.3s ease;
            }
        </style>
    </head>
    <body class="min-h-screen flex items-center justify-center">
        <div
            class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg flex flex-col items-center dark:bg-darkbg dark:text-darktext"
        >
            <h1
                class="text-2xl font-bold text-deepblue mb-2 dark:text-darktext"
            >
                Sign in to Intentionality
            </h1>
            <p
                class="text-gray-600 mb-6 text-center text-base dark:text-gray-300"
            >
                Sign in to sync your activity and unlock all features.
            </p>

            <!-- Email/Password Login Form -->
            <div id="emailLoginForm" class="w-full mb-4">
                <input
                    type="email"
                    id="emailInput"
                    placeholder="Email address"
                    class="w-full px-4 py-2.5 rounded-lg border border-gray-300 mb-3 text-base focus:outline-none focus:border-medblue dark:bg-slate-700 dark:border-slate-600 dark:text-darktext"
                />
                <input
                    type="password"
                    id="passwordInput"
                    placeholder="Password"
                    class="w-full px-4 py-2.5 rounded-lg border border-gray-300 mb-3 text-base focus:outline-none focus:border-medblue dark:bg-slate-700 dark:border-slate-600 dark:text-darktext"
                />
                <button
                    id="loginWithEmailButton"
                    class="w-full bg-medblue text-white py-2.5 px-4 rounded-lg text-base font-semibold hover:bg-deepblue transition-colors mb-2"
                >
                    Sign In
                </button>
                <button
                    id="signupWithEmailButton"
                    class="w-full bg-lightblue text-white py-2.5 px-4 rounded-lg text-base font-semibold hover:bg-medblue transition-colors mb-2"
                >
                    Create Account
                </button>
                <button
                    id="resetPasswordButton"
                    class="w-full text-medblue text-sm hover:underline dark:text-lightblue mb-3"
                >
                    Forgot password?
                </button>
            </div>

            <!-- Divider -->
            <div class="w-full flex items-center gap-3 mb-4">
                <div class="flex-1 h-px bg-gray-300 dark:bg-slate-600"></div>
                <span class="text-gray-500 text-sm dark:text-gray-400">or</span>
                <div class="flex-1 h-px bg-gray-300 dark:bg-slate-600"></div>
            </div>

            <button
                id="loginWithGoogleButton"
                class="google-btn w-full flex items-center justify-center gap-3 py-2.5 px-4 rounded-lg text-base mb-4 dark:google-btn-dark"
            >
                <i class="fab fa-google google-icon text-lg"></i>
                <span>Sign in with Google</span>
            </button>
            <a
                href="index.html"
                class="google-btn w-full flex items-center justify-center gap-3 py-2.5 px-4 rounded-lg text-base mb-4 dark:google-btn-dark"
            >
                <i class="fas fa-arrow-left"></i>
                Back to Home
            </a>
            <div
                id="loginStatus"
                class="text-medblue mt-5 text-center text-sm dark:text-lightblue"
            ></div>
        </div>

        <script>
            // Function to communicate with Chrome extension
            function sendToExtension(userInfo) {
                // Check if we're in a Chrome extension context
                if (
                    typeof chrome !== "undefined" &&
                    chrome.runtime &&
                    chrome.runtime.sendMessage
                ) {
                    // Send to specific extension ID
                    const EXTENSION_ID = "bgmlmjomgakcgkgngpeimmkofpicpbfn";

                    // Try sending to specific extension ID
                    chrome.runtime.sendMessage(
                        EXTENSION_ID,
                        {
                            type: "USER_LOGGED_IN",
                            userInfo: userInfo,
                            timestamp: Date.now(),
                        },
                        function (response) {
                            if (chrome.runtime.lastError) {
                                // Method 2: Try sending to any listening extension
                                try {
                                    chrome.runtime.sendMessage(
                                        {
                                            type: "USER_LOGGED_IN",
                                            userInfo: userInfo,
                                            timestamp: Date.now(),
                                        },
                                        function (response) {
                                            // Handle response if needed
                                        },
                                    );
                                } catch (broadcastError) {
                                    // Handle broadcast error
                                }
                            }
                        },
                    );

                    // Method 3: PostMessage to window (for content scripts)
                    try {
                        window.postMessage(
                            {
                                type: "INTENTIONALITY_USER_LOGGED_IN",
                                userInfo: userInfo,
                                source: "intentionality-login",
                            },
                            "*",
                        );
                    } catch (postMessageError) {
                        // Handle postMessage error
                    }
                } else {
                    // Alternative: Use localStorage for extension to pick up
                    try {
                        localStorage.setItem(
                            "intentionality_user_login",
                            JSON.stringify({
                                userInfo: userInfo,
                                timestamp: Date.now(),
                            }),
                        );

                        // Dispatch custom event
                        window.dispatchEvent(
                            new CustomEvent("intentionalityUserLoggedIn", {
                                detail: userInfo,
                            }),
                        );
                    } catch (localStorageError) {
                        // Handle localStorage error
                    }
                }
            }

            // Function to send login success to extension
            function sendLoginSuccessToExtension(user, token) {
                const EXTENSION_ID = "bgmlmjomgakcgkgngpeimmkofpicpbfn";

                if (
                    typeof chrome !== "undefined" &&
                    chrome.runtime &&
                    chrome.runtime.sendMessage
                ) {
                    chrome.runtime.sendMessage(
                        EXTENSION_ID,
                        {
                            type: "LOGIN_SUCCESS",
                            token: token,
                            userInfo: {
                                uid: user.uid,
                                email: user.email,
                                displayName: user.displayName,
                                photoURL: user.photoURL,
                                loginTime: new Date().toISOString(),
                            },
                        },
                        function (response) {
                            if (chrome.runtime.lastError) {
                                console.log(
                                    "Extension communication error:",
                                    chrome.runtime.lastError.message,
                                );
                            } else {
                                console.log("Login success sent to extension");
                            }
                        },
                    );
                }
            }

            const firebaseConfig = {
                apiKey: "AIzaSyCepAVjbZsx0z-M0sTvgp48AAt4bYBSq-U",
                authDomain: "intentionality-1ce65.firebaseapp.com",
                projectId: "intentionality-1ce65",
                storageBucket: "intentionality-1ce65.firebasestorage.app",
                messagingSenderId: "938266027514",
                appId: "1:938266027514:web:747ac62f30207ef05d3043",
                measurementId: "G-1891HVELCR",
            };

            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
            } catch (error) {
                // Handle Firebase initialization error
            }

            // Check current auth state
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    document.getElementById(
                        "loginStatus",
                    ).textContent = `✅ Signed in as ${
                        user.displayName || user.email
                    }`;
                } else {
                    document.getElementById("loginStatus").textContent =
                        "Not signed in";
                }
            });

            // Email/Password Login Handler
            document.getElementById("loginWithEmailButton").onclick =
                function () {
                    const email = document
                        .getElementById("emailInput")
                        .value.trim();
                    const password =
                        document.getElementById("passwordInput").value;

                    if (!email || !password) {
                        document.getElementById("loginStatus").textContent =
                            "❌ Please enter both email and password";
                        return;
                    }

                    document.getElementById("loginStatus").textContent =
                        "Signing in...";

                    firebase
                        .auth()
                        .signInWithEmailAndPassword(email, password)
                        .then((result) => {
                            document.getElementById(
                                "loginStatus",
                            ).textContent = `✅ Login successful! Welcome ${result.user.email}`;

                            // Get Firebase ID token and send to extension
                            result.user.getIdToken(true).then((token) => {
                                sendLoginSuccessToExtension(result.user, token);
                            });

                            // Store user info in sessionStorage
                            try {
                                const userInfo = {
                                    uid: result.user.uid,
                                    email: result.user.email,
                                    displayName: result.user.displayName,
                                    photoURL: result.user.photoURL,
                                    loginTime: new Date().toISOString(),
                                };
                                sessionStorage.setItem(
                                    "userInfo",
                                    JSON.stringify(userInfo),
                                );
                                sendToExtension(userInfo);
                            } catch (storageError) {
                                console.error("Storage error:", storageError);
                            }
                        })
                        .catch((error) => {
                            let errorMessage = "Login failed";
                            switch (error.code) {
                                case "auth/invalid-email":
                                    errorMessage = "❌ Invalid email address";
                                    break;
                                case "auth/user-disabled":
                                    errorMessage =
                                        "❌ This account has been disabled";
                                    break;
                                case "auth/user-not-found":
                                    errorMessage =
                                        "❌ No account found with this email";
                                    break;
                                case "auth/wrong-password":
                                    errorMessage = "❌ Incorrect password";
                                    break;
                                case "auth/invalid-credential":
                                    errorMessage =
                                        "❌ Invalid email or password";
                                    break;
                                default:
                                    errorMessage = "❌ " + error.message;
                            }
                            document.getElementById("loginStatus").textContent =
                                errorMessage;
                        });
                };

            // Email/Password Signup Handler
            document.getElementById("signupWithEmailButton").onclick =
                function () {
                    const email = document
                        .getElementById("emailInput")
                        .value.trim();
                    const password =
                        document.getElementById("passwordInput").value;

                    if (!email || !password) {
                        document.getElementById("loginStatus").textContent =
                            "❌ Please enter both email and password";
                        return;
                    }

                    if (password.length < 6) {
                        document.getElementById("loginStatus").textContent =
                            "❌ Password must be at least 6 characters";
                        return;
                    }

                    document.getElementById("loginStatus").textContent =
                        "Creating account...";

                    firebase
                        .auth()
                        .createUserWithEmailAndPassword(email, password)
                        .then((result) => {
                            document.getElementById(
                                "loginStatus",
                            ).textContent = `✅ Account created! Welcome ${result.user.email}`;

                            // Get Firebase ID token and send to extension
                            result.user.getIdToken(true).then((token) => {
                                sendLoginSuccessToExtension(result.user, token);
                            });

                            // Store user info in sessionStorage
                            try {
                                const userInfo = {
                                    uid: result.user.uid,
                                    email: result.user.email,
                                    displayName: result.user.displayName,
                                    photoURL: result.user.photoURL,
                                    loginTime: new Date().toISOString(),
                                };
                                sessionStorage.setItem(
                                    "userInfo",
                                    JSON.stringify(userInfo),
                                );
                                sendToExtension(userInfo);
                            } catch (storageError) {
                                console.error("Storage error:", storageError);
                            }
                        })
                        .catch((error) => {
                            let errorMessage = "Signup failed";
                            switch (error.code) {
                                case "auth/email-already-in-use":
                                    errorMessage =
                                        "❌ An account with this email already exists";
                                    break;
                                case "auth/invalid-email":
                                    errorMessage = "❌ Invalid email address";
                                    break;
                                case "auth/operation-not-allowed":
                                    errorMessage =
                                        "❌ Email/password accounts are not enabled";
                                    break;
                                case "auth/weak-password":
                                    errorMessage = "❌ Password is too weak";
                                    break;
                                default:
                                    errorMessage = "❌ " + error.message;
                            }
                            document.getElementById("loginStatus").textContent =
                                errorMessage;
                        });
                };

            // Password Reset Handler
            document.getElementById("resetPasswordButton").onclick =
                function () {
                    const email = document
                        .getElementById("emailInput")
                        .value.trim();

                    if (!email) {
                        document.getElementById("loginStatus").textContent =
                            "❌ Please enter your email address";
                        return;
                    }

                    document.getElementById("loginStatus").textContent =
                        "Sending password reset email...";

                    firebase
                        .auth()
                        .sendPasswordResetEmail(email)
                        .then(() => {
                            document.getElementById(
                                "loginStatus",
                            ).textContent = `✅ Password reset email sent to ${email}`;
                        })
                        .catch((error) => {
                            let errorMessage = "Password reset failed";
                            switch (error.code) {
                                case "auth/invalid-email":
                                    errorMessage = "❌ Invalid email address";
                                    break;
                                case "auth/user-not-found":
                                    errorMessage =
                                        "❌ No account found with this email";
                                    break;
                                default:
                                    errorMessage = "❌ " + error.message;
                            }
                            document.getElementById("loginStatus").textContent =
                                errorMessage;
                        });
                };

            // Login button click handler
            document.getElementById("loginWithGoogleButton").onclick =
                function () {
                    try {
                        const provider = new firebase.auth.GoogleAuthProvider();

                        // Add additional scopes if needed
                        provider.addScope("profile");
                        provider.addScope("email");

                        // Try popup first (better for localhost)
                        firebase
                            .auth()
                            .signInWithPopup(provider)
                            .then((result) => {
                                document.getElementById(
                                    "loginStatus",
                                ).textContent = `✅ Login successful! Welcome ${
                                    result.user.displayName || result.user.email
                                }`;

                                // Get Firebase ID token and send to extension
                                result.user.getIdToken(true).then((token) => {
                                    sendLoginSuccessToExtension(
                                        result.user,
                                        token,
                                    );
                                });

                                // Store user info in sessionStorage
                                try {
                                    const userInfo = {
                                        uid: result.user.uid,
                                        email: result.user.email,
                                        displayName: result.user.displayName,
                                        photoURL: result.user.photoURL,
                                        loginTime: new Date().toISOString(),
                                        accessToken: result.credential
                                            ? result.credential.accessToken
                                            : null,
                                        idToken: result.credential
                                            ? result.credential.idToken
                                            : null,
                                    };
                                    sessionStorage.setItem(
                                        "userInfo",
                                        JSON.stringify(userInfo),
                                    );

                                    // Communicate with Chrome extension
                                    sendToExtension(userInfo);
                                } catch (storageError) {
                                    // Handle storage error
                                }
                            })
                            .catch((error) => {
                                // If popup fails, fall back to redirect
                                if (
                                    error.code === "auth/popup-blocked" ||
                                    error.code === "auth/popup-closed-by-user"
                                ) {
                                    firebase
                                        .auth()
                                        .signInWithRedirect(provider);
                                } else {
                                    document.getElementById(
                                        "loginStatus",
                                    ).textContent =
                                        "Login failed: " + error.message;
                                }
                            });
                    } catch (error) {
                        document.getElementById("loginStatus").textContent =
                            "Error: " + error.message;
                    }
                };

            // Handle redirect result
            firebase
                .auth()
                .getRedirectResult()
                .then((result) => {
                    if (result.user) {
                        document.getElementById(
                            "loginStatus",
                        ).textContent = `✅ Login successful! Welcome ${
                            result.user.displayName || result.user.email
                        }`;

                        // Get Firebase ID token and send to extension
                        result.user.getIdToken(true).then((token) => {
                            sendLoginSuccessToExtension(result.user, token);
                        });

                        // Store user info in sessionStorage
                        try {
                            const userInfo = {
                                uid: result.user.uid,
                                email: result.user.email,
                                displayName: result.user.displayName,
                                photoURL: result.user.photoURL,
                                loginTime: new Date().toISOString(),
                            };
                            sessionStorage.setItem(
                                "userInfo",
                                JSON.stringify(userInfo),
                            );
                        } catch (storageError) {
                            // Handle storage error
                        }
                    }
                })
                .catch((error) => {
                    document.getElementById("loginStatus").textContent =
                        "Login failed: " + error.message;
                });
        </script>
    </body>
</html>
